$(()=>{const t={SEND_TRADITIONAL:'翻譯成繁體',SEND_SIMPLIFIED:'翻譯成簡體',OUTPUT:'翻譯最新回覆'},e='th-custom-extension-menu-item',n='開啟翻譯按鈕';let a=null,s=null;const i=async()=>{if(a&&s)return;const t=await import('https://testingcf.jsdelivr.net/npm/chinese-simple2traditional/+esm');a=t.toSimplified,s=t.toTraditional},o=(t,e)=>'traditional'===e?s?.(t)??t:a?.(t)??t,r=async t=>{const e=$('#send_textarea');if(0===e.length)return void toastr.error('找不到輸入框 #send_textarea');const n=String(e.val()??'');if(n)try{await i();const a=o(n,t);e.val(a),e.trigger('input').trigger('focus'),toastr.success('traditional'===t?'已轉換為繁體':'已轉換為簡體')}catch(t){console.error(t),toastr.error('繁簡轉換載入失敗')}},c=async(t,e)=>{const n=getChatMessages(t)[0];if(!n)return!1;const a=String(n.message??'');if(!a)return!1;await i();const s=o(a,e);return s!==a&&(await setChatMessages([{message_id:t,message:s}],{refresh:'affected'}),!0)},l=()=>{const t=f();return t.traditional?'traditional':t.simplified?'simplified':null},d=(t,e,n)=>function(){const a=Boolean(this.checked);v(t,a),a&&e.forEach(t=>v(t,!1)),toastr.success(n)},u=async t=>{const e=l();if(!e)return t?.silentNoTarget||console.log('請先勾選接收轉繁體或接收轉簡體'),!1;const n=getLastMessageId();return!(n<0)&&(await c(n,e)?(toastr.success('traditional'===e?'已將最新回覆轉為繁體':'已將最新回覆轉為簡體'),!0):(console.log('最新回覆無需轉換'),!1))};appendInexistentScriptButtons(Object.values(t).map(t=>({name:t,visible:!0})));const p={[t.SEND_TRADITIONAL]:()=>r('traditional'),[t.SEND_SIMPLIFIED]:()=>r('simplified'),[t.OUTPUT]:()=>u()};Object.entries(p).forEach(([t,e])=>{eventOn(getButtonEvent(t),()=>{e()})});const m=[{id:'auto-translate-send-input-checkbox-s',name:'自動將送出訊息轉為簡體',state:!1,label:'simplified',type:'send'},{id:'auto-translate-send-input-checkbox-t',name:'自動將送出訊息轉為繁體',state:!1,label:'traditional',type:'send'},{id:'auto-translate-receive-output-checkbox-s',name:'自動將收到的訊息轉為簡體',state:!1,label:'simplified',type:'receive'},{id:'auto-translate-receive-output-checkbox-t',name:'自動將收到的訊息轉為繁體',state:!1,label:'traditional',type:'receive'}],h=t=>m.find(e=>e.id===t),g=t=>h(t)?.state??!1,v=(t,e)=>{const n=h(t);n&&(n.state=e)},f=()=>({simplified:g('auto-translate-receive-output-checkbox-s'),traditional:g('auto-translate-receive-output-checkbox-t')}),b=new Set,x=()=>{$('.th-custom-popup-ui').remove();const t=m.map(t=>`<div class="flex-container alignitemscenter" style="gap:8px; margin-bottom:8px;">\n                        <input type="checkbox" id="${t.id}"\n                        name="${t.name}" ${t.state?'checked':''} />\n                        <label for="${t.id}">${t.name}</label>\n                    </div>`).join('\n'),e=$(`\n        <div class="th-custom-popup-ui" style="\n        position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n                width: min(640px, calc(100vw - 24px));\n                max-height: calc(100vh - 24px);\n                overflow: auto;\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n            padding: 16px;\n                z-index: 35000;\n        ">\n            <div class="inline-drawer">\n                <div class="inline-drawer-toggle inline-drawer-header"\n                    style="display:flex; justify-content:space-between; align-items:center;">\n                    <b>翻譯操作介面</b>\n                    <button type="button" class="menu_button th-custom-popup-close">關閉</button>\n                </div>\n\n                <div class="inline-drawer-content" style="display:block;">\n                    ${t}\n                </div>\n            </div>\n        </div>\n\n        `);e.appendTo('body'),e.find('.th-custom-popup-close').on('click',()=>{e.remove()});[{id:'auto-translate-send-input-checkbox-s',otherId:'auto-translate-send-input-checkbox-t',msg:'送出轉簡體'},{id:'auto-translate-send-input-checkbox-t',otherId:'auto-translate-send-input-checkbox-s',msg:'送出轉繁體'},{id:'auto-translate-receive-output-checkbox-s',otherId:'auto-translate-receive-output-checkbox-t',msg:'接收轉簡體'},{id:'auto-translate-receive-output-checkbox-t',otherId:'auto-translate-receive-output-checkbox-s',msg:'接收轉繁體'}].forEach(({id:t,otherId:n,msg:a})=>{e.find(`#${t}`).on('change',d(t,[n],`${a}：${g(t)?'開啟':'關閉'}`))})},y=()=>{if(document.getElementById(e))return;const t=$('#extensionsMenu');if(0===t.length)return;const a=t.find('.list-group').first().length>0?t.find('.list-group').first():t,s=$(`\n      <a id="${e}" class="list-group-item" href="javascript:void(0)">\n        <i class="fa-solid fa-wand-magic-sparkles"></i>\n        ${n}\n      </a>\n    `);s.on('click',x),a.append(s)};y(),eventMakeFirst(tavern_events.MESSAGE_SENT,async t=>{const e={simplified:g('auto-translate-send-input-checkbox-s'),traditional:g('auto-translate-send-input-checkbox-t')},n=e.traditional?'traditional':e.simplified?'simplified':null;if(n&&!b.has(t)){b.add(t);try{const e=stopAllGeneration();await c(t,n),e?await(async(t=3e3)=>{await new Promise(e=>{let n=!1,a=null,s=null;const i=()=>{n||(n=!0,a?.stop(),s?.stop(),e())};a=eventOnce(tavern_events.GENERATION_STOPPED,()=>i()),s=eventOnce(tavern_events.GENERATION_ENDED,()=>i()),setTimeout(i,t)})})():await new Promise(t=>setTimeout(t,100)),await triggerSlash('/trigger')}catch(t){console.error(t),console.log('自動繁簡轉換後送出失敗',t)}finally{b.delete(t)}}});const w=new Set;eventOn(tavern_events.MESSAGE_RECEIVED,async t=>{if(l()&&!w.has(t)&&t===getLastMessageId()){w.add(t);try{await u({silentNoTarget:!0})}catch(t){console.error(t),console.log('自動轉換最新回覆失敗',t)}finally{w.delete(t)}}});const k=new MutationObserver(()=>{y()});k.observe(document.body,{childList:!0,subtree:!0}),$(window).on('pagehide',()=>{k.disconnect(),$(`#${e}`).off('click'),$('.th-custom-popup-ui').remove()})});
//# sourceMappingURL=index.js.map